{% extends "base.html" %}
{% block content %}

<div class="mb-6">
 <a href="{{ url_for('index') }}" class="inline-block w-64 text-center border-2 border-primary-pink text-primary-pink py-2 rounded transition 
 hover:bg-primary-pink hover:text-white hover:shadow-lg focus-ring focus:outline-none font-medium">
 Voltar para a Loja
</a>
</div>

<div class="flex flex-col lg:flex-row gap-8 bg-white p-6 rounded-md-lg shadow-card">
 
 <div class="w-full lg:w-3/5 flex gap-4">
  <div class="flex-1">
   {# Imagem principal (primeira da lista) - corre√ß√£o para evitar filtro inv√°lido #}
   {% if product.images|length > 0 %}
     {% set main_img = product.images[0].image_url %}
   {% else %}
     {% set main_img = 'placeholder.jpg' %}
   {% endif %}

   <div class="mb-4">
    <img id="detail-main-image" src="{{ url_for('static', filename='images/' + main_img) }}" alt="{{ product.name }}" class="w-full h-auto object-cover rounded-md shadow-sm max-h-[600px] ">
   </div>

   <div class="flex gap-2 overflow-x-auto py-2 no-scrollbar" id="detail-thumbs">
    {# Miniaturas: garante que todas as imagens sejam exibidas #}
    {% for img in product.images %}
     <button class="thumb-btn border rounded p-0.5 flex-shrink-0 {% if loop.first %}ring-2 ring-primary-pink{% endif %}" data-src="{{ url_for('static', filename='images/' + img.image_url) }}">
      <img src="{{ url_for('static', filename='images/' + img.image_url) }}" class="w-20 h-20 object-cover rounded">
     </button>
    {% endfor %}
   </div>
  </div>
 </div>

 <div class="w-full lg:w-2/5 space-y-5">
  
  <div class="border-b pb-3">
   <h1 class="text-2xl font-bold">{{ product.name }} - REF:: {{ product.id }}</h1>
   <div class="flex items-center justify-between mt-3">
    
    <div class="text-right">
     {# Pre√ßo din√¢mico: JS ir√° atualizar #}
     <div class="text-sm" id="product-price-original">{% if product.discount_price and product.discount_price < product.price %}R$ {{ '%.2f' % product.price }}{% endif %}</div>
     <div class="text-2xl font-extrabold text-primary-pink" id="product-price">R$ {{ '%.2f' % (product.discount_price if product.discount_price is not none else product.price) }}</div>
    </div>
   </div>
  </div>

  <div class="text-sm space-y-3">
   <h3 class="font-bold text-gray-700">INFORMA√á√ïES:</h3>
   <p>{{ product.description }}</p>
   
   <h3 class="font-bold text-gray-700">CARACTER√çSTICAS PRINCIPAIS:</h3>
   <ul class="list-disc list-inside text-gray-600 space-y-1">
    {% for item in ["TECIDO RESPIR√ÅVEL", "PROTE√á√ÉO UV", "FLEXIBILIDADE"] %}
     <li>{{ item }}</li>
    {% endfor %}
   </ul>
  </div>
  
  <div class="space-y-4 border-t pt-4" id="selection-area">
   <h3 class="font-bold text-lg text-primary-pink">Personalize seu Pedido</h3>
      
   <div class="space-y-2" id="size-options">
    <h3 class="font-bold">TAMANHO:</h3>
    <div class="flex gap-3">
     {# CORRIGIDO: Agora itera APENAS sobre tamanhos com ESTOQUE INICIAL #}
     {% for size in sizes %}
      <label class="inline-flex items-center">
       <input type="radio" name="size" value="{{ size }}" class="form-radio size-radio text-primary-pink focus:ring-primary-pink">
       <span class="ml-2">{{ size }}</span>
      </label>
     {% endfor %}
    </div>
   </div>

   <div class="space-y-2" id="color-options">
    <h3 class="font-bold">COR:</h3>
    <div class="flex gap-3 items-center">
     {# CORRIGIDO: Agora itera APENAS sobre cores com ESTOQUE INICIAL #}
     {% for color in colors %}
      <label class="inline-flex items-center">
       <input type="radio" name="color" value="{{ color }}" class="form-radio color-radio text-primary-pink focus:ring-primary-pink">
       <span class="ml-2">{{ color }}</span>
      </label>
     {% endfor %}
    </div>
   </div>

   {# QUANTIDADE: Este bloco √© controlado pelo JS para mostrar o estoque real da varia√ß√£o selecionada #}
   <div id="quantity-block" class="mt-3 flex items-center gap-3" aria-hidden="true">
    <div class="flex items-center border rounded overflow-hidden">
     <button type="button" id="qty-decrement" class="px-3 py-1 text-lg text-gray-700" aria-label="Diminuir quantidade" disabled>-</button>
     <input id="qty-input" type="number" min="1" value="1" class="w-20 text-center border-l border-r px-2 py-1 focus-ring" disabled>
     <button type="button" id="qty-increment" class="px-3 py-1 text-lg text-gray-700" aria-label="Aumentar quantidade" disabled>+</button>
    </div>
    <div class="text-sm text-gray-600">
     Dispon√≠vel: <span id="stock-available">-</span>
    </div>
   </div>
  </div>
      
  <div class="space-y-4 pt-4 border-t">
  <h3 class="font-bold text-lg text-primary-pink">Op√ß√µes de Envio e Retirada</h3>
  
  <label for="option_pickup" class="block bg-primary-pink/10 p-4 rounded-md-lg border border-primary-pink/30 space-y-2 cursor-pointer hover:shadow-md transition">
    <div class="flex justify-between items-start">
      <div class="font-semibold flex items-center gap-2">
        <input type="radio" id="option_pickup" name="shipping_option" value="pickup" class="form-radio text-primary-pink focus:ring-primary-pink mt-1">
        <span class="text-gray-800 text-base font-semibold">üìç Retirar Pessoalmente (Gr√°tis)</span>
      </div>
      <a href="#" class="text-primary-pink hover:text-primary-pink-dark text-sm font-medium whitespace-nowrap">
        Ver Locais
      </a>
    </div>
    <p class="text-xs text-gray-600 mt-0.5">Compre online e retire em um ponto parceiro.</p>
  </label>
  
  <label for="option_delivery" class="block bg-primary-pink/10 p-4 rounded-md-lg border border-primary-pink/30 space-y-2 cursor-pointer hover:shadow-md transition">
    <div class="flex items-center gap-2 mb-2">
      <input type="radio" id="option_delivery" name="shipping_option" value="delivery" class="form-radio text-primary-pink focus:ring-primary-pink">
      <h3 class="font-bold text-gray-800">üöö Envio para seu Endere√ßo:</h3>
    </div>
    
    <div id="cep-calculator" class="flex gap-2 hidden"> 
      <input type="text" placeholder="Insira o CEP" class="w-full border rounded px-3 py-2 bg-white focus-ring">
      <button class="btn-primary px-4 py-2 rounded">Calcular</button>
    </div>
  </label>
</div>

  
  <textarea placeholder="Observa√ß√µes" class="w-full border rounded px-3 py-2 bg-gray-50 focus-ring h-20"></textarea>
 
 <button id="add-to-cart-btn"
    data-product-id="{{ product.id }}"
    data-product-name="{{ product.name|e }}"
    data-product-price="{{ '%.2f' % (product.discount_price if product.discount_price is not none else product.price) }}"
    class="btn-primary w-full py-3 rounded text-lg font-bold uppercase transition duration-200 mt-4"
    disabled>
 ADICIONAR AO CARRINHO
</button>

  <div class="flex flex-col gap-2 pt-2">
  
  <a href="https://wa.me/5599981629810" target="_blank" 
class="w-full text-center border border-primary-pink text-primary-pink py-3 rounded transition duration-200 
  hover:bg-primary-pink hover:text-white font-medium">
 Falar com a Vendedora
</a>
  </div>
 
  <div class="text-sm pt-4 border-t space-y-2 text-gray-600">
   <div class="flex items-center gap-2">
    <span class="text-primary-pink">‚úì</span> Conhe√ßa nossa pol√≠tica de trocas e devolu√ß√µes
   </div>
   <p>Atendimento ao cliente: +55 (99) 98162-9810</p>
  </div>

 </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const deliveryRadio = document.getElementById('option_delivery');
  const pickupRadio = document.getElementById('option_pickup');
  const cepCalculatorDiv = document.getElementById('cep-calculator');

  function updateCalculatorVisibility() {
    if (deliveryRadio.checked) {
      cepCalculatorDiv.classList.remove('hidden');
    } else {
      cepCalculatorDiv.classList.add('hidden');
    }
  }

  deliveryRadio.addEventListener('change', updateCalculatorVisibility);
  pickupRadio.addEventListener('change', updateCalculatorVisibility);
  
  updateCalculatorVisibility(); 
});
</script>

{# Variants data para o JS: id/size/color/quantity/price #}
<script>
 const PRODUCT_VARIANTS = [
  {% for v in variants %}
   { id: {{ v.id }}, size: "{{ v.size|e }}", color: "{{ v.color|e }}", quantity: {{ v.quantity }}, price: {{ v.price if v.price is not none else 'null' }} }{% if not loop.last %},{% endif %}
  {% endfor %}
 ];
</script>

{% endblock %}