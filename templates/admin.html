{% extends "base.html" %}
{% block content %}

<style>
.admin-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 1024px) { .admin-grid { grid-template-columns: 1fr 400px; } }

.product-card { 
  background: white; 
  border-radius: 0.5rem; 
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border-left: 4px solid #DDA8A0;
  transition: all 0.3s ease;
}
.product-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

.btn-danger { @apply bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition; }
.btn-success { @apply bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition; }
.btn-primary { @apply bg-primary-pink text-white px-3 py-2 rounded hover:opacity-90 transition; }
.btn-secondary { @apply bg-gray-400 text-white px-3 py-2 rounded hover:bg-gray-500 transition; }

.badge { @apply inline-block px-2 py-1 rounded text-xs font-semibold; }
.badge-info { @apply bg-blue-100 text-blue-800; }
.badge-success { @apply bg-green-100 text-green-800; }
.badge-warning { @apply bg-yellow-100 text-yellow-800; }
.badge-danger { @apply bg-red-100 text-red-800; }

/* Sidebar sticky apenas em telas grandes */
.sidebar-sticky { position: static; }
@media (min-width: 1024px) { .sidebar-sticky { position: static; top: 6rem; } }
</style>

<!-- WRAPPER PRINCIPAL DO LAYOUT -->
<div class="admin-grid">

  <!-- COLUNA PRINCIPAL (LISTAGEM E EDI√á√ÉO DE PRODUTOS) -->
  <div>
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">Painel Administrativo</h1>
      <p class="text-gray-600">Gerencie seus produtos, estoque e classifica√ß√µes</p>
    </div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="bg-green-50 border-2 border-green-400 text-green-800 p-4 rounded-lg mb-6 font-medium">
        <strong>Sucesso!</strong> {{ messages[0] }}
      </div>
    {% endif %}
    {% endwith %}

    {% with messages = get_flashed_messages(category_filter=['warning']) %}
    {% if messages %}
      <div class="bg-yellow-50 border-2 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-6 font-medium">
        <strong>‚ö†Ô∏è Aten√ß√£o!</strong> {{ messages[0] }}
      </div>
    {% endif %}
    {% endwith %}

    {% with messages = get_flashed_messages(category_filter=['error']) %}
    {% if messages %}
      <div class="bg-red-50 border-2 border-red-400 text-red-800 p-4 rounded-lg mb-6 font-medium">
        <strong>‚ùå Erro!</strong> {{ messages[0] }}
      </div>
    {% endif %}
    {% endwith %}

    <!-- BUSCA E FILTROS -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <form method="get" class="flex flex-col sm:flex-row gap-3">
        <input name="q" type="search" placeholder="Pesquisar produtos..."
          value="{{ q|default('') }}"
          class="flex-1 border-2 border-gray-200 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" />

        <button type="submit" class="btn-primary whitespace-nowrap">
          <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          Buscar
        </button>

        {% if q %}
        <a href="{{ url_for('admin_dashboard') }}" class="btn-secondary whitespace-nowrap">
          Limpar
        </a>
        {% endif %}
      </form>
    </div>

    <!-- LISTAGEM DE PRODUTOS POR CLASSIFICA√á√ÉO -->
    <div class="space-y-8">
      {% for c in classifications %}
      <section class="bg-white rounded-lg shadow-md p-6">
        <!-- HEADER SE√á√ÉO -->
        <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
          <div>
            <h2 class="text-2xl font-bold text-primary-pink">{{ c.name }}</h2>
            <p class="text-sm text-gray-500 mt-1">
              <span class="badge badge-info">{{ products|selectattr('classification','equalto', c)|list|length }} produtos</span>
            </p>
          </div>
        </div>

        {% set class_products = products|selectattr('classification','equalto', c)|list %}
        {% if class_products|length == 0 %}
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">Nenhum produto nesta classifica√ß√£o</p>
            <p class="text-sm text-gray-400 mt-2">Comece adicionando um novo produto usando o formul√°rio √† direita</p>
          </div>

        {% else %}
          <div class="space-y-4">
            {% for p in class_products %}

            <!-- PRODUCT CARD -->
            <div class="product-card p-0 overflow-hidden">
              <!-- HEADER DO CARD -->
              <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 p-4 sm:p-6 bg-gradient-to-r from-gray-50 to-white border-b-2 border-gray-100">
                <!-- THUMBNAIL -->
                {% if p.images|length > 0 %}
                {% set thumb = p.images[0].image_url %}
                {% else %}
                {% set thumb = 'placeholder.jpg' %}
                {% endif %}
                <img src="{{ thumb if thumb.startswith('http') else url_for('static', filename='images/' + thumb) }}"
                  alt="{{ p.name }}" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg border-2 border-gray-200 flex-shrink-0"
                  crossorigin="anonymous">

                <!-- INFO -->
                <div class="flex-1 min-w-0">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 truncate">{{ p.name }}</h3>
                    <span class="badge badge-info">REF {{ p.id }}</span>
                  </div>
                  <p class="text-sm text-gray-600 mb-3">
                    <span class="inline-block">{{ p.stock_variants|length }} varia√ß√µes</span> ‚Ä¢ 
                    <span class="inline-block">{{ p.images|length }} fotos</span>
                  </p>
                  <div class="flex flex-wrap gap-2">
                    <div class="text-sm font-bold text-primary-pink">
                      R$ {{ '%.2f' % (p.discount_price if p.discount_price is not none else p.price) }}
                    </div>
                    {% if p.discount_price and p.discount_price < p.price %}
                    <span class="badge badge-warning">-{{ '%.0f' % (((p.price - p.discount_price) / p.price) * 100) }}%</span>
                    {% endif %}
                  </div>
                </div>

                <!-- A√á√ïES R√ÅPIDAS -->
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                  <button class="toggle-product-details flex-1 sm:flex-none btn-primary text-base py-3 px-5 font-semibold" data-product-id="{{ p.id }}">
                    üìù Editar
                  </button>
                  <form action="{{ url_for('admin_delete', pid=p.id) }}" method="post" class="flex-1 sm:flex-none"
                    onsubmit="return confirm('Tem certeza que deseja deletar este produto? Esta a√ß√£o n√£o pode ser desfeita.');">
                    <button type="submit" class="btn-danger text-base py-3 px-5 w-full font-semibold">
                      üóëÔ∏è Deletar
                    </button>
                  </form>
                </div>
              </div>

              <!-- DETALHES (HIDDEN POR PADR√ÉO) -->
              <div class="product-details hidden p-4 sm:p-6 space-y-6" data-product-id="{{ p.id }}">
                
                <!-- EDI√á√ÉO DE INFORMA√á√ïES PRINCIPAIS -->
                <div>
                  <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Informa√ß√µes Principais
                  </h4>

                  <form action="{{ url_for('admin_edit', pid=p.id) }}" method="post"
                    class="space-y-4" enctype="multipart/form-data">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Produto</label>
                        <input name="name" value="{{ p.name }}" placeholder="Nome"
                          class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" required>
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Normal</label>
                        <div class="relative">
                          <span class="absolute left-3 top-2.5 text-gray-600">R$</span>
                          <input type="text" inputmode="decimal" name="price" value="{{ '%.2f' % p.price }}"
                            placeholder="99,90"
                            class="price-input w-full border-2 border-gray-300 rounded-lg px-8 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" required>
                        </div>
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo com Desconto (Opcional)</label>
                        <div class="relative">
                          <span class="absolute left-3 top-2.5 text-gray-600">R$</span>
                          <input type="text" inputmode="decimal" name="discount_price"
                            value="{% if p.discount_price %}{{ '%.2f' % p.discount_price }}{% endif %}"
                            placeholder="Deixe vazio para usar pre√ßo normal"
                            class="price-input w-full border-2 border-yellow-300 rounded-lg px-8 py-2 bg-yellow-50 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition">
                        </div>
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Classifica√ß√£o</label>
                        <select name="classification"
                          class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition">
                          <option value="">-- sem classifica√ß√£o --</option>
                          {% for c in classifications %}
                          <option value="{{ c.id }}"
                            {% if p.classification and p.classification.id == c.id %}selected{% endif %}>
                            {{ c.name }}
                          </option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                      <textarea name="description" placeholder="Descri√ß√£o completa do produto"
                        class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 h-24 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition resize-none">{{ p.description }}</textarea>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Adicionar Imagens (m√∫ltiplas)</label>
                      <input type="file" name="images" accept="image/*" multiple
                        class="w-full border-2 border-dashed border-gray-300 rounded-lg px-3 py-4 cursor-pointer hover:border-primary-pink transition">
                      <p class="text-xs text-gray-500 mt-2">Arraste arquivos ou clique para selecionar (PNG, JPG, GIF)</p>
                    </div>

                    <button type="submit"
                      class="w-full btn-primary font-bold py-3 flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      SALVAR INFORMA√á√ïES
                    </button>
                  </form>
                </div>

                <!-- GALERIA DE IMAGENS -->
                <div>
                  <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Galeria de Fotos ({{ p.images|length }})
                  </h4>

                  {% if p.images|length > 0 %}
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                      {% for img in p.images %}
                      <div class="relative group">
                        <img src="{{ img.image_url if img.image_url.startswith('http') else url_for('static', filename='images/' + img.image_url) }}"
                          alt="Foto" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200"
                          crossorigin="anonymous">
                        
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition flex items-center justify-center">
                          <form action="{{ url_for('admin_remove_image', image_id=img.id) }}"
                            method="post" class="hidden group-hover:block"
                            onsubmit="return confirm('Remover esta imagem?');">
                            <button type="submit" class="btn-danger p-2 rounded-full">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                              </svg>
                            </button>
                          </form>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                      <p class="text-gray-500">Nenhuma imagem neste produto</p>
                      <p class="text-sm text-gray-400 mt-2">Adicione imagens acima para exibir na galeria</p>
                    </div>
                  {% endif %}
                </div>

                <!-- ESTOQUE E VARIA√á√ïES -->
                <div>
                  <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m0 0l8 4m-8-4v10l8 4m0-10l8 4m-8-4v10"></path>
                    </svg>
                    Varia√ß√µes e Estoque
                  </h4>

                  <form action="{{ url_for('admin_edit_stock', pid=p.id) }}" method="post"
                    class="space-y-3 mb-6">
                    
                    {% if p.stock_variants|length > 0 %}
                      <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                          <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                              <th class="px-3 py-2 text-left font-bold">Tamanho</th>
                              <th class="px-3 py-2 text-left font-bold">Quantidade</th>
                              <th class="px-3 py-2 text-left font-bold">Pre√ßo Especial</th>
                              <th class="px-3 py-2 text-center font-bold">Status</th>
                              <th class="px-3 py-2 text-center font-bold">A√ß√£o</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for variant in p.stock_variants %}
                            <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                              <td class="px-3 py-3 font-medium">{{ variant.size }}</td>
                              <td class="px-3 py-3">
                                <input type="number" name="qty_{{ variant.id }}"
                                  value="{{ variant.quantity }}"
                                  class="w-20 border-2 border-gray-300 rounded px-2 py-1 text-center focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" min="0">
                              </td>
                              <td class="px-3 py-3">
                                <div class="relative">
                                  <span class="absolute left-2 top-1.5 text-gray-600">R$</span>
                                  <input type="text" name="price_{{ variant.id }}"
                                    value="{% if variant.price %}{{ '%.2f' % variant.price }}{% endif %}"
                                    class="w-24 border-2 border-gray-300 rounded px-6 py-1 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition text-center"
                                    placeholder="---">
                                </div>
                              </td>
                              <td class="px-3 py-3 text-center">
                                <label class="flex items-center justify-center gap-2 cursor-pointer">
                                  <input type="checkbox" name="available_{{ variant.id }}"
                                    {% if variant.is_available %}checked{% endif %}>
                                  <span class="text-xs font-semibold {% if variant.quantity == 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    {% if variant.quantity == 0 %}
                                    ESGOTADO
                                    {% else %}
                                    EM ESTOQUE
                                    {% endif %}
                                  </span>
                                </label>
                              </td>
                              <td class="px-3 py-3 text-center">
                                <form action="{{ url_for('admin_delete_variant', variant_id=variant.id) }}" method="post" style="display: inline;">
                                  <button type="submit" class="btn-danger text-xs py-1 px-2" onclick="return confirm('Deletar esta varia√ß√£o?')">
                                    Deletar
                                  </button>
                                </form>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>

                      <button type="submit"
                        class="w-full btn-success font-bold py-2 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Atualizar Estoque
                      </button>
                    {% else %}
                      <div class="text-center py-8 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                        <p class="text-yellow-800 font-medium">Nenhuma varia√ß√£o criada</p>
                        <p class="text-sm text-yellow-700 mt-1">Crie uma varia√ß√£o abaixo para adicionar estoque</p>
                      </div>
                    {% endif %}
                  </form>

                  <!-- CRIAR NOVA VARIA√á√ÉO -->
                  <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h5 class="font-bold text-blue-900 mb-4 flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                      Criar Nova Varia√ß√£o
                    </h5>

                    <form action="{{ url_for('admin_add_variant', pid=p.id) }}" method="post"
                      class="space-y-3">

                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Tamanho</label>
                          <select name="size" required
                            class="w-full border-2 border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">Selecione o tamanho</option>
                            <option value="PP">PP</option>
                            <option value="P">P</option>
                            <option value="M">M</option>
                            <option value="G">G</option>
                            <option value="GG">GG</option>
                            <option value="XG">XG</option>
                            <option value="XGG">XGG</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                            <option value="G3">G3</option>
                          </select>
                        </div>

                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo Especial (Opcional)</label>
                          <div class="relative">
                            <span class="absolute left-2 top-2 text-gray-600">R$</span>
                            <input type="text" inputmode="decimal" name="price" placeholder="Deixe vazio para usar o padr√£o"
                              class="price-input w-full border-2 border-gray-300 rounded px-6 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                          </div>
                        </div>

                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                          <input type="number" name="quantity" placeholder="0"
                            value="1" min="0"
                            class="w-full border-2 border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                      </div>

                      <button type="submit"
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Criar Varia√ß√£o
                      </button>
                    </form>
                  </div>
                </div>

              </div><!-- /product-details -->
            </div><!-- /product-card -->

            {% endfor %}
          </div>
        {% endif %}
      </section>
      {% endfor %}
    </div>
  </div>

  <!-- COLUNA DIREITA (SIDEBAR) -->
  <aside class="space-y-6">

    <!-- A√á√ïES R√ÅPIDAS -->
    <div class="bg-white rounded-lg shadow-md p-6 sidebar-sticky">
      <h3 class="text-xl font-bold text-primary-pink mb-6">A√ß√µes R√°pidas</h3>
      
      <div class="space-y-3">
        <button class="w-full btn-primary py-3 font-bold flex items-center justify-center gap-2" onclick="document.getElementById('add-product-section').scrollIntoView({behavior: 'smooth'})">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Novo Produto
        </button>
        
        <button class="w-full btn-secondary py-3 font-bold flex items-center justify-center gap-2" onclick="document.getElementById('add-classification-section').scrollIntoView({behavior: 'smooth'})">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          Nova Classifica√ß√£o
        </button>
      </div>
    </div>

    <!-- CRIAR CLASSIFICA√á√ÉO -->
    <div id="add-classification-section" class="bg-white rounded-lg shadow-md p-6">
      <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
        </svg>
        Criar Classifica√ß√£o
      </h4>
      
      <form action="{{ url_for('admin_add_classification') }}" method="post" class="space-y-3">
        <input name="name" placeholder="Nome da classifica√ß√£o"
          class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" required>
        <button type="submit" class="w-full btn-primary font-bold py-2">
          Criar
        </button>
      </form>
    </div>

    <!-- LISTA DE CLASSIFICA√á√ïES -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path>
        </svg>
        Classifica√ß√µes
      </h4>

      {% if classifications %}
      <form action="{{ url_for('admin_reorder_classifications') }}" method="post" class="space-y-3 max-h-72 overflow-y-auto">
        {% for c in classifications %}
        <div class="bg-gray-50 rounded-lg p-3 border-2 border-gray-200 hover:border-primary-pink transition flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <input type="number" name="order_{{ c.id }}" value="{{ c.display_order or 0 }}" class="w-16 border-2 border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink text-center" aria-label="Ordem de {{ c.name }}">
            <div>
              <span class="font-semibold text-gray-800">{{ c.name }}</span>
              <span class="badge badge-info ml-2">{{ products|selectattr('classification','equalto', c)|list|length }}</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button type="submit" class="text-red-500 hover:text-red-700 transition text-sm font-medium"
              formaction="{{ url_for('admin_delete_classification', class_id=c.id) }}" formmethod="post"
              onclick="return confirm('Deletar esta classifica√ß√£o?')">
              <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
        {% endfor %}
        <button type="submit" class="w-full btn-primary font-bold py-2">Salvar ordem</button>
      </form>
      {% else %}
      <div class="text-center py-6">
        <p class="text-gray-500">Nenhuma classifica√ß√£o criada</p>
        <p class="text-xs text-gray-400 mt-1">Crie uma acima</p>
      </div>
      {% endif %}
    </div>

    <!-- ADICIONAR PRODUTO -->
    <div id="add-product-section" class="bg-white rounded-lg shadow-md p-6">
      <h4 class="font-bold text-primary-pink mb-4 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Adicionar Novo Produto
      </h4>

      <form action="{{ url_for('admin_add') }}" method="post" enctype="multipart/form-data" class="space-y-4">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Produto</label>
          <input name="name" placeholder="Ex: Camiseta Fitness"
            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" required>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Normal</label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-600">R$</span>
            <input type="text" inputmode="decimal" name="price" placeholder="99,90"
              class="price-input w-full border-2 border-gray-300 rounded-lg px-8 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo com Desconto (Opcional)</label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-600">R$</span>
            <input type="text" inputmode="decimal" name="discount_price" placeholder="Deixe em branco se n√£o houver"
              class="price-input w-full border-2 border-yellow-300 rounded-lg px-8 py-2 bg-yellow-50 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Classifica√ß√£o</label>
          <select name="classification" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition">
            <option value="">-- sem classifica√ß√£o --</option>
            {% for c in classifications %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Imagens (m√∫ltiplas)</label>
          <input type="file" name="images" accept="image/*" multiple
            class="w-full border-2 border-dashed border-gray-300 rounded-lg px-4 py-6 cursor-pointer hover:border-primary-pink transition">
          <p class="text-xs text-gray-500 mt-2">PNG, JPG ou GIF (m√°x 10MB cada)</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
          <textarea name="description" placeholder="Descreva o produto..."
            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 h-24 resize-none focus:ring-2 focus:ring-primary-pink focus:border-primary-pink transition"></textarea>
        </div>

        <button type="submit"
          class="w-full btn-primary font-bold py-3 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Adicionar Produto
        </button>
      </form>
    </div>

    <!-- LOGOUT -->
    <div class="bg-red-50 rounded-lg border-2 border-red-300 p-4">
      <a href="{{ url_for('logout') }}"
        class="w-full block text-center bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 transition">
        Sair do Painel
      </a>
    </div>

  </aside>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Toggle product details
  document.querySelectorAll('.toggle-product-details').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const productId = btn.dataset.productId;
      const details = document.querySelector(`.product-details[data-product-id="${productId}"]`);
      if (details) {
        details.classList.toggle('hidden');
        // Scroll para o card se estiver oculto
        if (!details.classList.contains('hidden')) {
          details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
    });
  });

  // Format price inputs - BRL currency (comma decimal separator)
  const priceInputs = document.querySelectorAll('.price-input');
  
  function formatPriceInput(value) {
    // Remove everything that's not a digit
    let cleaned = value.replace(/\D/g, '');
    
    // If empty, return empty
    if (!cleaned) return '';
    
    // Ensure at least 3 digits (for proper decimal placement)
    if (cleaned.length < 3) {
      cleaned = cleaned;
    } else {
      // Last 2 digits are decimals
      let integerPart = cleaned.slice(0, -2);
      let decimalPart = cleaned.slice(-2);
      
      // Add thousands separator (dot) to integer part
      integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      // If no integer part, set to 0
      if (!integerPart) integerPart = '0';
      
      // Combine with comma as decimal separator
      cleaned = integerPart + ',' + decimalPart;
    }
    
    return cleaned;
  }
  
  priceInputs.forEach(input => {
    // On input: format in real-time as user types
    input.addEventListener('input', (e) => {
      let value = e.target.value;
      
      // Only keep digits
      let cleaned = value.replace(/\D/g, '');
      
      if (!cleaned) {
        e.target.value = '';
        return;
      }
      
      // If 1-2 digits, show as is (user is still typing)
      if (cleaned.length <= 2) {
        e.target.value = cleaned;
      } else {
        // 3+ digits: format with comma as decimal
        let integerPart = cleaned.slice(0, -2);
        let decimalPart = cleaned.slice(-2);
        
        // Add thousands separator
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        e.target.value = integerPart + ',' + decimalPart;
      }
    });

    // On blur: ensure proper formatting with 2 decimal places
    input.addEventListener('blur', (e) => {
      let value = e.target.value.trim();
      
      if (value === '') {
        e.target.value = '0,00';
        return;
      }
      
      // Remove formatting, keep only digits
      let cleaned = value.replace(/\D/g, '');
      
      if (!cleaned) {
        e.target.value = '0,00';
        return;
      }
      
      // If 1-2 digits were entered, treat as reais (not cents)
      // User typed "88" -> should be "88,00" not "0,88"
      if (cleaned.length === 1) {
        e.target.value = cleaned + ',00';
        return;
      }
      
      if (cleaned.length === 2) {
        e.target.value = cleaned + ',00';
        return;
      }
      
      let integerPart = cleaned.slice(0, -2);
      let decimalPart = cleaned.slice(-2);
      
      // Add thousands separator
      integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      e.target.value = integerPart + ',' + decimalPart;
    });

    // Prevent paste of invalid characters
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      
      // Extract only numbers
      let cleaned = pastedText.replace(/\D/g, '');
      
      if (!cleaned) {
        e.target.value = '';
        return;
      }
      
      // If 1-2 digits, show as is
      if (cleaned.length <= 2) {
        e.target.value = cleaned;
      } else {
        // 3+ digits: format with comma as decimal
        let integerPart = cleaned.slice(0, -2);
        let decimalPart = cleaned.slice(-2);
        
        // Add thousands separator
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        e.target.value = integerPart + ',' + decimalPart;
      }
    });
  });
});
</script>

{% endblock %}
